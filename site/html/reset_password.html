<div class="card" style="max-width: 350px;">
	<div class="card-inner">
		<h1>Reset Password</h1>
		<p>
			To request a password reset code, input your username
			and click the "Request Code" button. A notification
			will be sent to all devices you have logged in on
			that have notifications enabled.
			<br>
			<u>This code is valid for 5 minutes only.</u>
			<br><br>
			If you do not have any devices with notifications enabled,
			please contact an administrator for help.
		</p>

		<input id="username" placeholder="Username" format="id" required>&nbsp;
		<button class="icon tooltip" id="request-code-button">
			<i class="fa-solid fa-unlock fa-lg" id="request-code-icon"></i>
			<span class="tooltiptext t-center">Request reset code</span>
		</button>
		<br>
		<input id="code" placeholder="Reset Code" format="id" required><br>

		<br>

		<div>
			<input id="user-new-password" type="password" placeholder="New Password" autocomplete="new-password">
			&nbsp;
			<span id="password-strength" class="hidden" style="font-size: 80%;"></span>
		</div>

		<input id="user-new-password2" type="password" placeholder="Confirm Password" autocomplete="new-password">
		<button class="icon tooltip" id="submit-button">
			<i class="fa-solid fa-right-to-bracket fa-lg"></i>
			<span class="tooltiptext t-center">Update password</span>
		</button>

		<div class="expand-container" id="password-hints">
			<div>
				New password must:
				<ul style="font-size: 80%; margin-top: 0.5rem;">
					<li><span id="pw1">Be at least 8 characters long</span></li>
					<li><span id="pw2">Not contain your username</span></li>
					<li><span id="pw3">Not be a subset of your username</span></li>
					<li><span id="pw4">Contain at least 2 of the following:</span>
						<ul>
							<li><span id="pw5">Uppercase letters</span></li>
							<li><span id="pw6">Lowercase letters</span></li>
							<li><span id="pw7">Numbers</span></li>
							<li><span id="pw8">Special characters</span></li>
						</ul>
					</li>
				</ul>
			</div>
		</div>

		<div id="errormsg" class="emphasis"></div>
	</div>
</div>

<script>
	$('user-new-password').onfocus = expand_password_hints
	$('user-new-password2').onfocus = contract_password_hints
	$.bind('user-new-password', check_password, 10)
	$('submit-button').onclick = update_password
	$('request-code-button').onclick = request_code

	async function request_code() {
		const username = $('username').value
		if (username.length === 0) {
			$.flash('username')
			return
		}

		// Lock the button to prevent too many requests
		$('request-code-button').disabled = true
		$('request-code-icon').classList.add('suppress', 'fa-lock')
		$('request-code-icon').classList.remove('fa-unlock')

		try {
			await api.request_reset_code(username)
		} catch (err) {
			$('errormsg').innerText = err.message || 'An unexpected error occurred. Please contact an administrator.'
		}

		//Unlock the button after a little bit
		setTimeout(() => {
			$('request-code-button').disabled = false
			$('request-code-icon').classList.remove('suppress', 'fa-lock')
			$('request-code-icon').classList.add('fa-unlock', 'fa-lg', 'fa-solid')
		}, 1000)
	}

	function password_strength(password) {
		if (password.length < 8) return 0 //very weak
		if (password.includes(api.username)) return 0 //very weak
		if (api.username.includes(password)) return 0 //very weak

		const has_upper = /[A-Z]/.test(password)
		const has_lower = /[a-z]/.test(password)
		const has_number = /[0-9]/.test(password)
		const has_symbol = /[!@#$%^&*(),.?":{}|<>]/.test(password)

		const long_password = password.length >= 12 ? 1 : 0

		const score = has_upper + has_lower + has_number + has_symbol + long_password
		return score
	}

	function is_valid_password(password) {
		if (password.length < 8) return false
		if (password.includes(api.username)) return false
		if (api.username.includes(password)) return false

		const has_upper = /[A-Z]/.test(password)
		const has_lower = /[a-z]/.test(password)
		const has_number = /[0-9]/.test(password)
		const has_symbol = /[!@#$%^&*(),.?":{}|<>]/.test(password)

		if (has_upper + has_lower + has_number + has_symbol < 2) return false

		return true
	}

	function check_password() {
		const password = $.val('user-new-password')

		const criteria = {
			'pw1': password.length >= 8,
			'pw2': !password.includes(api.username) && password.length > 0,
			'pw3': !api.username.includes(password) && password.length > 0,
			'pw5': /[A-Z]/.test(password),
			'pw6': /[a-z]/.test(password),
			'pw7': /[0-9]/.test(password),
			'pw8': /[!@#$%^&*(),.?":{}|<>]/.test(password),
		}
		criteria.pw4 = (criteria.pw5 + criteria.pw6 + criteria.pw7 + criteria.pw8) >= 2

		for (const [key, valid] of Object.entries(criteria)) {
			$(key).style.textDecoration = valid ? 'line-through' : ''
			$(key).classList.toggle('suppress', valid)
		}

		const score = [
			'Very Weak',
			'Weak',
			'Fair',
			'Good',
			'Strong',
			'Very Strong',
		][password_strength(password)]
		$('password-strength').innerText = score
	}

	function expand_password_hints() {
		$.toggle_expand('password-hints', true)
		$.show('password-strength')
	}

	function contract_password_hints() {
		$.toggle_expand('password-hints', false)
		$.hide('password-strength', true)
	}

	async function update_password() {
		const password = $('user-new-password').value
		const username = $('username').value
		const code = $('code').value.trim().toLowerCase()

		let errored = false

		if (username.length === 0) {
			$.flash('username')
			errored = true
		}

		if (password.length === 0) {
			$.flash('user-new-password')
			$.flash('user-new-password2')
			errored = true
		}

		if (code.length === 0) {
			$.flash('code')
			errored = true
		}

		if (errored) return

		if (!is_valid_password(password)) {
			$.flash('user-new-password')
			expand_password_hints()
			return
		}

		if (password !== $.val('user-new-password2')) {
			$('password-strength').innerText = 'Not matching'
			$.toggle_expand('password-hints', false)
			$.show('password-strength')
			$.flash('user-new-password')
			$.flash('user-new-password2')
			return
		}

		//Hide the password hints and score, since the password is valid
		contract_password_hints()

		try {
			await api.reset_password(username, code, password)
		} catch (err) {
			$('errormsg').innerText = err.message || 'An unexpected error occurred. Please contact an administrator.'
			return
		}

		//Success
		alert('Password updated successfully. Please log in with your new password.')
		navigate('html/login.html')
	}
</script>
